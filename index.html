<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Log</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
      .log-entry { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
      /* Custom focus style for the dictation button */
      .dictation-button-active {
          box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.5); /* Tailwind red-500 equivalent */
      }
    </style>
    
    <!-- 1. Load Lucide Icons (asynchronously, sets window.lucide) -->
    <script type="module">
      import * as lucide from 'https://esm.run/lucide-react@0.292.0';
      window.lucide = lucide; // Expose globally
    </script>
    
    <!-- 2. Load Firebase SDKs (asynchronously, sets window.firebase) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global window object
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp
        };
    </script>
</head>
<body>
    <div id="root">
        <!-- Initial loading message while waiting for async modules -->
        <div class="flex flex-col items-center justify-center h-40 text-gray-500">
             <svg class="animate-spin h-6 w-6 text-indigo-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <span class="font-medium">Loading application resources...</span>
        </div>
    </div>

    <!-- 3. Main React Application (Defined in Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        // --- Global Variables for Canvas Environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Speech Recognition setup 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = !!SpeechRecognition;

        const PROJECT_OPTIONS = ['Test Project', 'Daily Reflection', 'Meeting Notes', 'Idea Brainstorming', 'Create New Project'];

        /**
         * Component for selecting the log type (Voice, Photo, Video)
         */
        const ModeButton = ({ mode, icon: Icon, label, currentMode, onClick }) => (
            <button
                onClick={() => onClick(mode)}
                className={`flex flex-col items-center justify-center p-3 rounded-xl transition duration-150 w-full sm:w-1/3 border-2 ${
                    currentMode === mode
                        ? 'bg-indigo-600 text-white border-indigo-700 shadow-lg scale-105'
                        : 'bg-white text-gray-700 border-gray-200 hover:bg-indigo-50 hover:text-indigo-600'
                }`}
            >
                <Icon className="w-6 h-6 mb-1" />
                <span className="text-xs font-semibold">{label}</span>
            </button>
        );

        /**
         * Main application component for the Daily Multi-Media Log.
         */
        const App = () => {
          // Access all external dependencies safely *inside* the component
          const firebase = window.firebase || {};
          const lucide = window.lucide || {};
          
          // Safely destructure Firebase functions and Lucide Icons (Added Camera and Video)
          const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp } = firebase;
          const { Mic, Save, Loader, XCircle, List, User, Tag, Camera, Video, AlertTriangle } = lucide; 

          const [db, setDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);
          const [currentMode, setCurrentMode] = useState('voice'); // Feature selection: voice, photo, video

          const [logEntries, setLogEntries] = useState([]);
          const [dictatedText, setDictatedText] = useState('');
          const [isRecording, setIsRecording] = useState(false);
          const [error, setError] = useState(null);
          const [statusMessage, setStatusMessage] = useState('Initializing application...');
          
          const [currentProject, setCurrentProject] = useState(PROJECT_OPTIONS[0]);

          const recognitionRef = useRef(null);
          
          // Fallback check for missing dependencies
          if (!initializeApp || !Mic || !Camera) { // Check for a few critical icons
             return (
                 <div className="min-h-screen p-4 sm:p-8 font-sans">
                     <div className="flex justify-center items-center p-8 bg-white rounded-xl shadow-lg mt-4">
                         {/* Using raw SVG as fallback */}
                         <svg className="animate-spin h-6 w-6 text-indigo-500 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                         <span className="text-gray-600 font-medium">Loading application resources. Please wait...</span>
                     </div>
                 </div>
             );
          }


          // --- 1. Firebase Initialization and Authentication ---
          useEffect(() => {
            if (!firebaseConfig) {
              setError('Firebase configuration is missing.');
              return;
            }

            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              const dbInstance = getFirestore(app);

              setDb(dbInstance);

              const authenticate = async () => {
                try {
                  if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                  } else {
                    await signInAnonymously(authInstance);
                  }
                } catch(e) {
                     console.error("Authentication failed, falling back to anonymous sign-in:", e);
                     await signInAnonymously(authInstance);
                }
              };

              const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                  setUserId(user.uid);
                  setStatusMessage(`Authentication successful. User ID: ${user.uid}. Ready to log.`);
                } else {
                  // If the user is null, we explicitly set userId to null to prevent Firestore permission errors.
                  setUserId(null); 
                  setStatusMessage('Waiting for authentication to resolve...');
                }
                setIsAuthReady(true);
              });

              authenticate();
              return () => unsubscribe();
            } catch (e) {
              console.error("Firebase Initialization Error:", e);
              setError('Failed to initialize Firebase.');
            }
          }, []);

          // --- 2. Firestore Listener for Real-Time Log Entries ---
          useEffect(() => {
            // Listener only runs when db is initialized, auth is checked, AND we have a valid userId (uid).
            if (!isAuthReady || !db || !userId) return;

            // Define the private collection path
            const logsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'daily_logs');
            const q = query(logsCollectionRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
              const entries = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Convert Firestore Timestamp to JS Date and handle undefined
                createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date(),
              })).sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime()); // Sort newest first in JS

              setLogEntries(entries);
              setStatusMessage(`Found ${entries.length} log entries.`);
            }, (e) => {
              console.error("Firestore Snapshot Error:", e);
              setError("Failed to fetch log entries from Firestore.");
            });

            return () => unsubscribe();
          }, [isAuthReady, db, userId]);

          // --- 3. Save Function ---
          const saveDictatedText = async () => {
            // Check for valid userId (not null)
            if (!dictatedText.trim() || !db || !userId) {
                setStatusMessage('Error: Dictation pad is empty or not authenticated.');
                return;
            }

            // Ensure recording is stopped before saving
            if (isRecording) stopDictation();

            const logsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'daily_logs');

            try {
              await addDoc(logsCollectionRef, {
                text: dictatedText.trim(),
                project: currentProject, // Save the selected project
                logType: 'voice', // Mark this as a voice log
                createdAt: serverTimestamp(),
              });
              setDictatedText('');
              setStatusMessage(`Voice entry saved successfully under the '${currentProject}' project!`);
            } catch (e) {
              console.error('Error saving document:', e);
              setError('Could not save the entry. Check console for details.');
            }
          };
          
          // --- 4. Stop Dictation Function ---
          const stopDictation = () => {
              if (recognitionRef.current) {
                  recognitionRef.current.stop();
              }
              setIsRecording(false);
              setStatusMessage('Dictation stopped. Review and save the transcript.');
          };

          // --- 5. Start Dictation Function ---
          const startDictation = () => {
            if (!isSpeechRecognitionSupported) {
              setError('Your browser does not support the Web Speech API.');
              return;
            }
            if (isRecording) return; // Prevent double-start

            // Stop any previous instance just in case
            if (recognitionRef.current) recognitionRef.current.stop();

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
              setIsRecording(true);
              setError(null);
              setStatusMessage('LISTENING: Speak clearly now! Click the red button to stop.');
            };

            recognition.onresult = (event) => {
              let interimTranscript = '';
              let finalTranscript = '';

              // Build the full transcript from results
              for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                  finalTranscript += transcript + ' ';
                } else {
                  interimTranscript += transcript;
                }
              }

              // Update the text area with the existing text + the new final/interim text
              const newText = (dictatedText + ' ' + finalTranscript + interimTranscript).trim();
              setDictatedText(newText);
            };

            recognition.onerror = (event) => {
              console.error('Speech Recognition Error:', event.error);
              setError(`Dictation Error: ${event.error}. Try again.`);
              setIsRecording(false);
            };

            recognition.onend = () => {
              setIsRecording(false);
              setStatusMessage('Dictation session ended. Press the microphone button to start a new session.');
            };
            
            recognitionRef.current = recognition; // Store the current recognition instance
            recognition.start(); // Start the dictation only when this function is called
          };
          
          // Toggles between start and stop dictation
          const handleDictationToggle = () => {
              if (isRecording) {
                  stopDictation();
              } else {
                  startDictation();
              }
          };
          
          // Placeholder component for unimplemented features
          const PlaceholderCard = useMemo(() => ({ mode }) => (
            <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl mb-8 border border-gray-100 text-center">
                <AlertTriangle className="w-10 h-10 text-yellow-500 mx-auto mb-4" />
                <h2 className="text-xl font-semibold mb-2 text-gray-700">{mode === 'photo' ? 'Photo Note' : 'Video Memo'} Feature</h2>
                <p className="text-gray-500">
                    This feature is currently under development. Switch back to **Voice Dictation** to start logging immediately!
                </p>
            </div>
          ), []);
          
          // Voice Dictation Card Component (for clean conditional rendering)
          const VoiceEntryCard = useMemo(() => () => (
            <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl mb-8 border border-gray-100">
                <h2 className="text-xl font-semibold mb-4 text-gray-700">New Log Entry</h2>
                
                {/* Project Selector */}
                <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-500 mb-1 flex items-center">
                        <Tag className="w-4 h-4 mr-1" /> Project/Tag
                    </label>
                     <select
                        value={currentProject}
                        onChange={(e) => setCurrentProject(e.target.value)}
                        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                     >
                        {PROJECT_OPTIONS.map(proj => (
                            <option key={proj} value={proj}>{proj}</option>
                        ))}
                     </select>
                </div>

                {/* Dictation Area */}
                <textarea
                    value={dictatedText}
                    onChange={(e) => setDictatedText(e.target.value)}
                    placeholder={isSpeechRecognitionSupported ? "Start speaking after clicking the microphone..." : "Speech recognition is not supported in this browser. Type your log here."}
                    className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none text-gray-800"
                    disabled={isRecording}
                />

                {/* Controls */}
                <div className="mt-4 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4">
                    
                    {/* Dictation Button - ALWAYS RED, only the active glow changes */}
                    {isSpeechRecognitionSupported && (
                         <button
                            onClick={handleDictationToggle}
                            className={`flex items-center justify-center w-full sm:w-auto px-6 py-3 rounded-full text-white font-semibold transition duration-200 transform hover:scale-105 shadow-lg bg-red-500 hover:bg-red-600 ${isRecording ? 'dictation-button-active' : ''}`}
                            disabled={!isAuthReady}
                        >
                            {isRecording ? (
                                <>
                                    <Loader className="w-5 h-5 mr-3 animate-spin" />
                                    STOP RECORDING
                                </>
                            ) : (
                                <>
                                    <Mic className="w-5 h-5 mr-3" />
                                    START DICTATION
                                </>
                            )}
                        </button>
                    )}
                    
                    {/* Save Button */}
                    <button
                        onClick={saveDictatedText}
                        className="flex items-center justify-center w-full sm:w-auto px-6 py-3 rounded-full bg-green-500 text-white font-semibold transition duration-200 transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:shadow-none"
                        disabled={!dictatedText.trim() || !isAuthReady || isRecording}
                    >
                        <Save className="w-5 h-5 mr-3" />
                        SAVE VOICE ENTRY
                    </button>
                </div>
            </div>
          ), [isRecording, dictatedText, currentProject, isAuthReady, handleDictationToggle, saveDictatedText]);


          // --- UI Rendering ---
          return (
            <div className="min-h-screen p-4 sm:p-8 font-sans bg-gray-50">
              <div className="max-w-4xl mx-auto">
                
                {/* Header */}
                <header className="py-4 mb-6 border-b border-indigo-100">
                    <h1 className="text-3xl font-bold text-indigo-700 flex items-center">
                        <List className="mr-3 h-7 w-7" />
                        Daily Log
                    </h1>
                    <p className="text-sm text-gray-500 mt-1 flex items-center">
                        <User className="w-4 h-4 mr-1"/> User ID: <code className="ml-2 font-mono text-xs p-1 bg-indigo-50 text-indigo-800 rounded">{userId || 'Loading...'}</code>
                    </p>
                </header>

                {/* Status/Error Messages */}
                {error && (
                  <div className="p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-center">
                    <XCircle className="w-5 h-5 mr-2"/>
                    {error}
                  </div>
                )}
                {statusMessage && !error && (
                    <div className="p-3 mb-6 bg-indigo-50 text-indigo-600 rounded-lg text-sm">
                        {statusMessage}
                    </div>
                )}
                
                {/* Mode Selector - Restored Photo, Video, and Voice Icons */}
                <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                    <ModeButton mode="voice" icon={Mic} label="Voice Dictation" currentMode={currentMode} onClick={setCurrentMode} />
                    <ModeButton mode="photo" icon={Camera} label="Photo Note" currentMode={currentMode} onClick={setCurrentMode} />
                    <ModeButton mode="video" icon={Video} label="Video Memo" currentMode={currentMode} onClick={setCurrentMode} />
                </div>
                
                {/* Dynamic Log Input Card */}
                {currentMode === 'voice' && <VoiceEntryCard />}
                {currentMode === 'photo' && <PlaceholderCard mode="photo" />}
                {currentMode === 'video' && <PlaceholderCard mode="video" />}

                {/* Log History */}
                <div className="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100">
                    <h2 className="text-xl font-semibold text-gray-700 mb-6">Log History ({logEntries.length})</h2>
                    
                    {logEntries.length === 0 ? (
                        <p className="text-center text-gray-500 p-8 border-2 border-dashed border-gray-200 rounded-xl">
                            No log entries found yet. Start dictating and save your first entry!
                        </p>
                    ) : (
                        <div className="space-y-4">
                            {logEntries.map((entry) => (
                                <div key={entry.id} className="log-entry p-4 border border-gray-200 rounded-xl bg-gray-50 hover:shadow-md transition">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className={`inline-block text-xs font-medium px-3 py-1 rounded-full ${entry.logType === 'voice' ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-200 text-gray-700'}`}>
                                            {entry.project} ({entry.logType || 'text'})
                                        </span>
                                        <time className="text-xs text-gray-500">
                                            {entry.createdAt.toLocaleString()}
                                        </time>
                                    </div>
                                    <p className="text-gray-800 whitespace-pre-wrap">{entry.text}</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

              </div>
            </div>
          );
        };

        // --- Polling and Initialization Script (Ensures React only mounts once dependencies are ready) ---
        const mountApp = () => {
            // FIX: Use explicit local variables for short-circuit evaluation to prevent ReferenceErrors 
            // when checking asynchronous dependencies in the global scope.
            const isFirebaseLoaded = !!window.firebase;
            // Check for a few critical icons to ensure Lucide is fully loaded
            const isLucideReady = !!(window.lucide && window.lucide.Mic && window.lucide.Camera);
            
            if (isFirebaseLoaded && isLucideReady) {
                 console.log("Dependencies loaded. Mounting React App.");
                 const container = document.getElementById('root');
                 if (container) {
                     const root = createRoot(container);
                     root.render(<App />);
                 }
                 return true; // Success
            }
            console.log("Waiting for dependencies. Firebase:", isFirebaseLoaded, "Lucide Ready:", isLucideReady);
            return false; // Still waiting
        };

        // Set up the polling mechanism
        const pollDependencies = () => {
            const maxAttempts = 50;
            let attempts = 0;
            const intervalTime = 100; // Check every 100ms
            
            const interval = setInterval(() => {
                if (mountApp() || attempts >= maxAttempts) {
                    clearInterval(interval);
                    if (attempts >= maxAttempts) {
                        console.error("Failed to load all dependencies after max attempts.");
                        document.getElementById('root').innerHTML = '<div class="flex justify-center items-center h-40 text-red-500 font-bold">Error: Could not load required application files. Please refresh.</div>';
                    }
                }
                attempts++;
            }, intervalTime);
        };

        // Start polling when the window loads
        window.onload = pollDependencies;

    </script>
</body>
</html>
