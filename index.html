<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Dictation & Project Log</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel for JSX compilation in the browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Lucide Icons for React (must use type="module") -->
    <script type="module">
      import * as lucide from 'https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js';
      // Expose the entire Lucide module globally
      window.lucide = lucide;
      window.React = window.React || React;
      window.ReactDOM = window.ReactDOM || ReactDOM;
    </script>
    
    <!-- Load Firebase SDKs (must use type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global window object
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp
        };
    </script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
      .log-entry { transition: transform 0.3s ease-out, opacity 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Main React Application using Babel for compilation -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        // --- Global Variables for Canvas Environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Speech Recognition setup (must be accessed globally)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = !!SpeechRecognition;

        const PROJECT_OPTIONS = ['Test Project', 'Daily Reflection', 'Meeting Notes', 'Idea Brainstorming', 'Create New Project'];

        /**
         * Main application component for the Daily Dictation Log.
         */
        const App = () => {
          // CRITICAL FIX: Access all external dependencies safely *inside* the component
          // to ensure they are available after the asynchronous module loading is complete.
          const firebase = window.firebase || {};
          const lucide = window.lucide || {};
          
          const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp } = firebase;
          const { Mic, Save, Loader, XCircle, List, User, Tag } = lucide; // Destructure icons safely

          const [db, setDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [isAuthReady, setIsAuthReady] = useState(false);

          const [logEntries, setLogEntries] = useState([]);
          const [dictatedText, setDictatedText] = useState('');
          const [isRecording, setIsRecording] = useState(false);
          const [error, setError] = useState(null);
          const [statusMessage, setStatusMessage] = useState('Initializing application...');
          
          const [currentProject, setCurrentProject] = useState(PROJECT_OPTIONS[0]);

          const recognitionRef = useRef(null);
          
          // --- Early Dependency Check (Handles case where modules fail to load entirely) ---
          if (!initializeApp || !Mic) {
            return (
                <div className="min-h-screen p-4 sm:p-8 font-sans">
                    <h1 className="text-3xl font-bold text-gray-900 mb-4">Voice Log Tester</h1>
                    <div className="flex justify-center items-center p-8 bg-white rounded-xl shadow-lg mt-4">
                        {/* Use a simple text loader as a fallback if Loader icon is not available */}
                        <span className="text-gray-600 font-medium">Loading dependencies... Please wait.</span>
                    </div>
                </div>
            );
          }


          // --- 1. Firebase Initialization and Authentication ---
          useEffect(() => {
            if (!firebaseConfig) {
              setError('Firebase configuration is missing.');
              return;
            }

            try {
              const app = initializeApp(firebaseConfig);
              const authInstance = getAuth(app);
              const dbInstance = getFirestore(app);

              setDb(dbInstance);

              const authenticate = async () => {
                try {
                  if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                  } else {
                    await signInAnonymously(authInstance);
                  }
                } catch(e) {
                     console.error("Authentication failed, falling back to anonymous sign-in:", e);
                     await signInAnonymously(authInstance);
                }
              };

              const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                if (user) {
                  setUserId(user.uid);
                  setIsAuthReady(true);
                  setStatusMessage('Authentication successful. Ready to log.');
                } else {
                  setUserId('unauthenticated');
                  setIsAuthReady(true);
                  setStatusMessage('Signed in anonymously. Ready to log.');
                }
              });

              authenticate();
              return () => unsubscribe();
            } catch (e) {
              console.error("Firebase Initialization Error:", e);
              setError('Failed to initialize Firebase.');
            }
          }, []);

          // --- 2. Firestore Listener for Real-Time Log Entries ---
          useEffect(() => {
            if (!isAuthReady || !db || !userId) return;

            const logsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'daily_logs');
            const q = query(logsCollectionRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
              const entries = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                // Convert Firestore Timestamp to JS Date and handle undefined
                createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date(),
              })).sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime()); // Sort newest first

              setLogEntries(entries);
              setStatusMessage(`Found ${entries.length} log entries.`);
            }, (e) => {
              console.error("Firestore Snapshot Error:", e);
              setError("Failed to fetch log entries from Firestore.");
            });

            return () => unsubscribe();
          }, [isAuthReady, db, userId]);

          // --- 3. Save Function ---
          const saveDictatedText = async () => {
            if (!dictatedText.trim() || !db || !userId) {
                setStatusMessage('Error: Dictation pad is empty or not authenticated.');
                return;
            }

            const logsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'daily_logs');

            try {
              await addDoc(logsCollectionRef, {
                text: dictatedText.trim(),
                project: currentProject, // Save the selected project
                createdAt: serverTimestamp(),
              });
              setDictatedText('');
              setStatusMessage(`Entry saved successfully under the '${currentProject}' project!`);
            } catch (e) {
              console.error('Error saving document:', e);
              setError('Could not save the entry. Check console for details.');
            }
          };

          // --- 4. Voice Dictation Functions ---
          const startDictation = () => {
            if (!isSpeechRecognitionSupported) {
              setError('Your browser does not support the Web Speech API.');
              return;
            }

            if (recognitionRef.current) recognitionRef.current.stop();

            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
              setIsRecording(true);
              setError(null);
              setStatusMessage('LISTENING: Speak clearly now! Click the red button to stop.');
            };

            recognition.onresult = (event) => {
              let interimTranscript = '';
              let finalTranscript = '';

              for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                  finalTranscript += transcript + ' ';
                } else {
                  interimTranscript += transcript;
                }
              }

              setDictatedText(prevText => {
                const updatedText = prevText.trim() + ' ' + finalTranscript + interimTranscript;
                return updatedText.trim();
              });
            };

            recognition.onerror = (event) => {
              console.error('Speech Recognition Error:', event.error);
              setIsRecording(false);
              if (event.error === 'not-allowed') {
                setError('Microphone permission denied. Please enable it in your browser settings and try again.');
              } else {
                setError(`Dictation error: ${event.error}. Click the mic button to retry.`);
              }
              setStatusMessage('Dictation failed or paused.');
            };

            recognition.onend = () => {
              if (isRecording) {
                 setIsRecording(false);
                 setStatusMessage('Dictation paused automatically. Ready to save.');
              }
            };

            recognitionRef.current = recognition;
            recognition.start();
          };

          const stopDictation = () => {
            if (recognitionRef.current) {
              recognitionRef.current.stop();
              setIsRecording(false);
              setStatusMessage('Recording stopped manually. Ready to save.');
            }
          };

          // --- 5. Loading and Error UI Components ---
          const LoadingIndicator = () => (
            <div className="flex justify-center items-center p-8 bg-white rounded-xl shadow-lg mt-4">
              <Loader className="animate-spin mr-2 h-6 w-6 text-indigo-500" />
              <span className="text-gray-600 font-medium">Initializing...</span>
            </div>
          );

          const ErrorDisplay = ({ message }) => (
            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-sm mb-4 flex items-center">
                <XCircle className="h-5 w-5 mr-2" />
                <p className="font-medium">{message}</p>
            </div>
          );

          if (error) {
            return (
                <div className="p-4 sm:p-8">
                    <h1 className="text-3xl font-bold text-gray-900 mb-4">Voice Log Tester</h1>
                    <ErrorDisplay message={error} />
                </div>
            );
          }

          if (!isAuthReady) {
            return (
                <div className="p-4 sm:p-8">
                    <h1 className="text-3xl font-bold text-gray-900 mb-4">Voice Log Tester</h1>
                    <LoadingIndicator />
                </div>
            );
          }

          // --- 6. JSX Structure ---
          return (
            <div className="min-h-screen p-4 sm:p-8 font-sans">
              
              {/* Header and Status */}
              <header className="mb-8 bg-white p-4 rounded-xl shadow-lg">
                <h1 className="text-3xl font-extrabold text-gray-900 flex items-center">
                  <Mic className="text-indigo-600 mr-2 h-8 w-8" />
                  Voice Log Tester
                </h1>
                <p className="text-sm text-gray-500 mt-1">{statusMessage}</p>
                <div className="mt-2 text-xs text-gray-500 flex items-center">
                    <User className="h-4 w-4 mr-1" />
                    **Current User ID:** <span className="font-mono text-indigo-600 ml-1 break-all">{userId}</span>
                </div>
              </header>

              {/* Dictation Input Section */}
              <section className="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 className="text-xl font-semibold text-gray-800 mb-4">Dictation Pad</h2>

                {/* Project Dropdown */}
                <div className="mb-4 flex items-center">
                    <Tag className="h-5 w-5 mr-2 text-indigo-500" />
                    <label htmlFor="project-select" className="text-sm font-medium text-gray-700 mr-3">
                        Select Project:
                    </label>
                    <select
                        id="project-select"
                        value={currentProject}
                        onChange={(e) => setCurrentProject(e.target.value)}
                        className="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        disabled={isRecording}
                    >
                        {PROJECT_OPTIONS.map(proj => (
                            <option key={proj} value={proj}>{proj}</option>
                        ))}
                    </select>
                </div>

                {!isSpeechRecognitionSupported && (
                     <ErrorDisplay message="Voice dictation (Web Speech API) is not available in your browser." />
                )}

                <textarea
                  className={`w-full p-3 border ${isRecording ? 'border-red-500 ring-4 ring-red-200' : 'border-gray-300'} rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all`}
                  rows="5"
                  placeholder={isRecording ? 'LISTENING: Start talking now...' : 'Dictated text will appear here. Press the mic button to start recording for the selected project.'}
                  value={dictatedText}
                  onChange={(e) => setDictatedText(e.target.value)}
                  disabled={isRecording}
                />

                <div className="flex space-x-4 mt-4">
                  <button
                    onClick={isRecording ? stopDictation : startDictation}
                    disabled={!isSpeechRecognitionSupported}
                    className={`flex-1 flex items-center justify-center px-6 py-3 rounded-xl font-bold text-white transition-all transform shadow-md ${
                      isRecording
                        ? 'bg-red-500 hover:bg-red-600 active:scale-95'
                        : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'
                    } disabled:opacity-50 disabled:cursor-not-allowed`}
                  >
                    {isRecording ? (
                      <span className="flex items-center"><Loader className="animate-spin h-5 w-5 mr-2" /> Stop Recording</span>
                    ) : (
                      <span className="flex items-center"><Mic className="h-5 w-5 mr-2" /> Start Dictation</span>
                    )}
                  </button>

                  <button
                    onClick={saveDictatedText}
                    disabled={!dictatedText.trim() || isRecording}
                    className="flex-1 flex items-center justify-center px-6 py-3 rounded-xl font-bold text-white bg-green-500 hover:bg-green-600 active:scale-95 transition-all transform shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Save className="h-5 w-5 mr-2" />
                    Save Log
                  </button>
                </div>
              </section>

              {/* Daily Log Overview Section */}
              <section className="bg-white p-6 rounded-xl shadow-lg">
                <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                  <List className="h-5 w-5 mr-2 text-indigo-600" />
                  Daily Log Overview (All Entries)
                </h2>

                {logEntries.length === 0 && (
                  <p className="text-gray-500 italic p-4 border-2 border-dashed border-gray-200 rounded-lg">
                    No entries yet. Start recording and save your first log!
                  </p>
                )}

                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {logEntries.map((entry) => (
                    <div
                      key={entry.id}
                      className="log-entry p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg shadow-sm hover:shadow-md"
                    >
                      <div className="flex justify-between items-start mb-1">
                          <span className="text-xs font-semibold px-2 py-0.5 bg-indigo-200 text-indigo-800 rounded-full flex items-center">
                              <Tag className="h-3 w-3 mr-1" /> {entry.project || 'Uncategorized'}
                          </span>
                          <p className="text-xs text-gray-500">
                            {entry.createdAt.toLocaleDateString()} at {entry.createdAt.toLocaleTimeString()}
                          </p>
                      </div>
                      <p className="text-gray-800 leading-relaxed whitespace-pre-wrap">{entry.text}</p>
                    </div>
                  ))}
                </div>
              </section>

            </div>
          );
        };

        // Render the App once the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('root');
            if (container) {
                const root = createRoot(container);
                root.render(<App />);
            }
        });
    </script>
</body>
</html>
