<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Log App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Dark Theme Styles for better contrast and mood */
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --background-color: #0f172a; /* Slate 900 */
            --card-background: #1e293b; /* Slate 800 */
            --text-color: #f1f5f9; /* Slate 100 */
            --secondary-text: #94a3b8; /* Slate 400 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .log-card {
            background-color: var(--card-background);
            border: 1px solid #334155; /* Slate 700 */
        }
        
        /* Custom button styling for interactivity and shadow */
        .action-button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .action-button:hover:not(:disabled) {
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -4px rgba(79, 70, 229, 0.2);
            transform: translateY(-1px);
        }

        .action-button:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: none;
        }

        /* Voice button specific pulsing animation */
        .voice-recording {
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
    </style>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons for Buttons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen">

<div class="container">
    <header class="text-center mb-10">
        <h1 class="text-5xl font-extrabold text-indigo-400">Daily Log</h1>
        <p class="text-xl mt-2 text-secondary-text">Capture your day using text, voice, photos, or video.</p>
        <p id="user-status" class="text-xs mt-1 text-gray-500"></p>
    </header>

    <!-- Input Section -->
    <section class="log-card p-6 rounded-xl shadow-2xl mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">New Entry</h2>
        
        <div id="error-message" class="hidden p-3 bg-red-900 text-red-300 rounded-lg mb-4"></div>
        <div id="status-message" class="hidden p-3 bg-indigo-900 text-indigo-300 rounded-lg mb-4"></div>

        <textarea id="log-text" class="w-full p-4 h-32 rounded-xl bg-slate-700 text-text-color resize-none focus:ring-2 focus:ring-indigo-500 border-none outline-none transition-colors" placeholder="Type your thoughts here, or use the buttons below..."></textarea>

        <div class="flex flex-wrap gap-4 mt-4">
            <!-- Voice Dictation Button -->
            <button id="voice-button" class="action-button flex-1 min-w-[120px] sm:min-w-0 flex items-center justify-center p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-500 disabled:opacity-50" title="Start Voice Dictation">
                <i data-lucide="mic" class="w-5 h-5 mr-2"></i> 
                <span id="voice-label">Start Voice</span>
            </button>
            
            <!-- Photo Upload Button -->
            <button id="photo-button" class="action-button flex-1 min-w-[120px] sm:min-w-0 flex items-center justify-center p-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-500 disabled:opacity-50" title="Upload Photo">
                <i data-lucide="camera" class="w-5 h-5 mr-2"></i> 
                Photo
            </button>
            <input type="file" id="photo-input" accept="image/*" class="hidden">

            <!-- Video Upload Button -->
            <button id="video-button" class="action-button flex-1 min-w-[120px] sm:min-w-0 flex items-center justify-center p-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-500 disabled:opacity-50" title="Upload Video">
                <i data-lucide="video" class="w-5 h-5 mr-2"></i> 
                Video
            </button>
            <input type="file" id="video-input" accept="video/*" class="hidden">

            <!-- Save Button -->
            <button id="save-button" class="action-button w-full sm:w-auto flex-grow flex items-center justify-center p-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-500 disabled:opacity-50" disabled>
                <i data-lucide="save" class="w-5 h-5 mr-2"></i> 
                Save Log
            </button>
        </div>
        
        <!-- Placeholder for media preview -->
        <div id="media-preview" class="mt-4 p-3 border border-slate-600 rounded-xl hidden">
            <h3 class="text-sm font-medium mb-2 text-secondary-text">Media Attached:</h3>
            <!-- Content will be injected here -->
        </div>
    </section>

    <!-- Log History Section -->
    <section class="log-card p-6 rounded-xl shadow-2xl">
        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Log History</h2>
        <div id="log-history" class="space-y-4">
            <p id="loading-logs" class="text-center text-secondary-text">Loading logs...</p>
        </div>
    </section>
</div>

<!-- Firebase SDK Imports (MUST be type="module") -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Provided by Canvas Environment) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // --- State and DOM Elements ---
    let db, auth, userId = null;
    let isAuthReady = false;
    let currentMedia = null; // Stores { type: 'image'/'video', data: base64_string }
    let isRecording = false;

    const logTextEl = document.getElementById('log-text');
    const saveButtonEl = document.getElementById('save-button');
    const voiceButtonEl = document.getElementById('voice-button');
    const photoButtonEl = document.getElementById('photo-button');
    const photoInputEl = document.getElementById('photo-input');
    const videoButtonEl = document.getElementById('video-button');
    const videoInputEl = document.getElementById('video-input');
    const logHistoryEl = document.getElementById('log-history');
    const mediaPreviewEl = document.getElementById('media-preview');
    const userStatusEl = document.getElementById('user-status');
    const voiceLabelEl = document.getElementById('voice-label');
    const errorEl = document.getElementById('error-message');
    const statusEl = document.getElementById('status-message');
    
    // --- Utility Functions ---

    const showMessage = (element, message, isError = false) => {
        element.textContent = message;
        element.classList.remove('hidden');
        if (isError) {
            element.classList.add('bg-red-900', 'text-red-300');
            element.classList.remove('bg-indigo-900', 'text-indigo-300');
        } else {
            element.classList.add('bg-indigo-900', 'text-indigo-300');
            element.classList.remove('bg-red-900', 'text-red-300');
        }
        setTimeout(() => element.classList.add('hidden'), 5000);
    };

    const setError = (message) => showMessage(errorEl, message, true);
    const setStatus = (message) => showMessage(statusEl, message, false);

    const checkSaveEnablement = () => {
        const hasText = logTextEl.value.trim().length > 0;
        const hasMedia = currentMedia !== null;
        saveButtonEl.disabled = !(hasText || hasMedia);
    };

    const getFirestorePath = (collectionName, docId) => {
        const base = `/artifacts/${appId}/users/${userId}/${collectionName}`;
        // Using doc(db, path, id) if docId is provided, otherwise collection(db, path)
        return docId ? doc(db, base, docId) : collection(db, base);
    };
    
    // --- Firebase Setup ---
    const initializeFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else if (!user && initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (e) {
                        console.error("Custom token sign-in failed, falling back to anonymous:", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'anonymous';
                isAuthReady = true;
                userStatusEl.textContent = `User ID: ${userId}`;
                
                setupLogListener();
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setError("Failed to initialize the database.");
        }
    };
    
    // --- Real-time Log Listener ---
    const setupLogListener = () => {
        if (!db || !userId) return;

        const q = query(getFirestorePath('daily_logs'));
        
        onSnapshot(q, (snapshot) => {
            logHistoryEl.innerHTML = '';
            
            if (snapshot.empty) {
                logHistoryEl.innerHTML = '<p class="text-center text-secondary-text p-4">No logs yet. Start documenting your day!</p>';
                document.getElementById('loading-logs')?.remove();
                return;
            }

            snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                // Sort by timestamp descending
                .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0))
                .forEach(entry => {
                    logHistoryEl.appendChild(createLogElement(entry));
                });
            
            // Re-render Lucide icons after DOM update
            lucide.createIcons();
        }, (error) => {
            console.error("Error fetching logs:", error);
            setError("Failed to load log history in real-time.");
        });
    };

    // --- DOM Creation for Log Entry ---
    const createLogElement = (entry) => {
        const date = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Saving...';
        
        const div = document.createElement('div');
        div.className = 'p-4 log-card rounded-xl shadow-lg border border-slate-700';
        
        let mediaHtml = '';
        if (entry.media) {
            const mediaType = entry.media.type;
            const mediaData = entry.media.data;
            
            // Note: Data is stored without the mime prefix, so we add it back here
            if (mediaType === 'image') {
                mediaHtml = `<img src="data:image/jpeg;base64,${mediaData}" alt="Logged Image" class="w-full h-auto max-h-60 object-contain rounded-lg mt-3 border border-slate-600">`;
            } else if (mediaType === 'video') {
                mediaHtml = `<video controls src="data:video/mp4;base64,${mediaData}" class="w-full h-auto max-h-60 object-contain rounded-lg mt-3 border border-slate-600">Video Log</video>`;
            } else if (mediaType === 'audio') {
                // Assuming voice recording, though currently only dictation-to-text is implemented
                mediaHtml = `<audio controls src="data:audio/wav;base64,${mediaData}" class="w-full mt-3">Audio Log</audio>`;
            }
        }

        div.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-medium text-indigo-400 flex items-center">
                    <i data-lucide="calendar" class="w-3 h-3 mr-1"></i> ${date}
                </span>
                <button class="delete-log text-red-500 hover:text-red-400 transition-colors" data-id="${entry.id}" title="Delete Log">
                     <i data-lucide="trash-2" class="w-4 h-4"></i> 
                </button>
            </div>
            <p class="text-sm whitespace-pre-wrap">${entry.text || 'No text recorded.'}</p>
            ${mediaHtml}
        `;
        
        // Add delete listener (must be done after element creation)
        const deleteButton = div.querySelector('.delete-log');
        if(deleteButton) {
            deleteButton.addEventListener('click', () => handleDeleteLog(entry.id));
        }

        return div;
    };
    
    // --- Log Saving Function ---
    const handleSaveLog = async () => {
        if (!db || !userId || saveButtonEl.disabled) return;

        const text = logTextEl.value.trim();
        if (!text && !currentMedia) {
            setError("Log must contain text or media.");
            return;
        }

        setStatus("Saving log entry...");
        saveButtonEl.disabled = true;

        try {
            const logData = {
                text: text,
                media: currentMedia, // currentMedia is null if no media attached
                timestamp: serverTimestamp(),
            };

            // Use setDoc with no document ID to let Firestore auto-generate one for a new document
            await setDoc(doc(getFirestorePath('daily_logs')), logData);

            // Clear state on success
            logTextEl.value = '';
            currentMedia = null;
            clearMediaPreview();
            setStatus("Log saved successfully!");
        } catch (e) {
            console.error("Error saving log:", e);
            setError("Failed to save log entry. See console for details.");
        } finally {
            saveButtonEl.disabled = false;
            checkSaveEnablement();
        }
    };
    
    // --- Log Deletion Function ---
    const handleDeleteLog = async (docId) => {
        if (!db || !userId) return;
        
        setStatus("Deleting log...");
        
        try {
            // deleteDoc takes the document reference
            await deleteDoc(getFirestorePath('daily_logs', docId));
            setStatus("Log deleted.");
        } catch (e) {
            console.error("Error deleting log:", e);
            setError("Failed to delete log entry.");
        }
    };

    // --- Media Input Handlers ---
    
    const clearMediaPreview = () => {
        currentMedia = null;
        mediaPreviewEl.classList.add('hidden');
        mediaPreviewEl.innerHTML = '<h3 class="text-sm font-medium mb-2 text-secondary-text">Media Attached:</h3>';
        checkSaveEnablement();
    };

    const handleMediaChange = (event, type) => {
        const file = event.target.files[0];
        if (!file) {
            clearMediaPreview();
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => {
            // Store the raw base64 data for Firestore
            // We strip the mime-type prefix from the base64 string before storing
            const base64Data = reader.result.split(',')[1];
            currentMedia = { type: type, data: base64Data };

            // Update Preview
            mediaPreviewEl.classList.remove('hidden');
            if (type === 'image') {
                mediaPreviewEl.innerHTML = `<h3 class="text-sm font-medium mb-2 text-secondary-text">Photo Attached:</h3><img src="${reader.result}" class="w-full h-auto max-h-40 object-contain rounded-lg">`;
            } else if (type === 'video') {
                mediaPreviewEl.innerHTML = `<h3 class="text-sm font-medium mb-2 text-secondary-text">Video Attached:</h3><video controls src="${reader.result}" class="w-full h-auto max-h-40 object-contain rounded-lg">`;
            }

            checkSaveEnablement();
            setStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} attached successfully. Ready to save!`);
        };
        
        // Convert file to base64
        reader.readAsDataURL(file);
    };

    // --- Voice Dictation Handler (Uses Web Speech API) ---
    const setupVoiceDictation = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            voiceButtonEl.disabled = true;
            voiceButtonEl.innerHTML = '<i data-lucide="volume-x" class="w-5 h-5 mr-2"></i> Voice Not Supported';
            setError("Your browser does not support Web Speech API (Voice Dictation).");
            lucide.createIcons();
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        const setRecordingState = (recording) => {
            isRecording = recording;
            voiceLabelEl.textContent = recording ? 'Stop Recording' : 'Start Voice';
            
            // Handle UI changes
            if (recording) {
                voiceButtonEl.classList.add('voice-recording', 'bg-red-700');
                voiceButtonEl.classList.remove('bg-red-600');
            } else {
                voiceButtonEl.classList.remove('voice-recording', 'bg-red-700');
                voiceButtonEl.classList.add('bg-red-600');
            }
            
            // Update the Lucide icon
            const iconElement = voiceButtonEl.querySelector('i');
            if (iconElement) {
                iconElement.setAttribute('data-lucide', recording ? 'square' : 'mic'); 
                lucide.createIcons(); 
            }
        };

        recognition.onstart = () => {
            setRecordingState(true);
            setStatus("Listening... start speaking now.");
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            // Append the final result to the existing text area content
            logTextEl.value += finalTranscript;
            checkSaveEnablement();
        };

        recognition.onend = () => {
            // Called when recognition stops, either naturally or via recognition.stop()
            setRecordingState(false);
            setStatus("Voice dictation stopped.");
        };

        recognition.onerror = (event) => {
            setRecordingState(false);
            setError(`Voice Error: ${event.error}. Please ensure microphone access is granted in your browser settings or a security popup.`);
        };
        
        // This is the main button click handler
        voiceButtonEl.addEventListener('click', () => {
            if (isRecording) {
                // If currently recording, stop it. This triggers onend.
                recognition.stop();
            } else {
                // If not recording, start it. This triggers onstart.
                try {
                    recognition.start();
                } catch(e) {
                    if (e.name === 'InvalidStateError') {
                        setStatus("Already attempting to listen...");
                    } else {
                        console.error("Recognition start failed:", e);
                        setError("Could not start microphone. Check permissions or try another browser.");
                    }
                }
            }
        });
    };

    // --- Event Listeners and Initial Load ---
    window.onload = () => {
        // Initialize Firebase on load
        initializeFirebase(); 

        // Initial check for save button status
        logTextEl.addEventListener('input', checkSaveEnablement);
        saveButtonEl.addEventListener('click', handleSaveLog);
        
        // Setup Media Inputs
        photoButtonEl.addEventListener('click', () => photoInputEl.click());
        photoInputEl.addEventListener('change', (e) => handleMediaChange(e, 'image'));

        videoButtonEl.addEventListener('click', () => videoInputEl.click());
        videoInputEl.addEventListener('change', (e) => handleMediaChange(e, 'video'));

        // Setup Voice Dictation
        setupVoiceDictation();

        // Initialize Lucide icons
        lucide.createIcons();
    };

</script>
</body>
</html>
