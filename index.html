<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Log App</title>
    
    <!-- FAVICON PLACEHOLDER -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General professional font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styling for the pulsing effect when recording */
        .voice-recording {
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); /* Standard Red Pulse */
            }
            50% {
                box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
            }
        }

        /* Custom style for the Save button (bright yellow #FFFF00) */
        .bg-custom-yellow {
            background-color: #FFFF00;
        }
        .hover\:bg-custom-yellow-hover:hover {
            /* Slightly darker yellow for hover effect */
            background-color: #CCCC00; 
        }

        /* Custom style for the Video button (Light Gray #D1D0CE) */
        .bg-custom-video-green {
            background-color: #D1D0CE; /* Changed from #00FF00 */
            color: #1f2937; /* dark text for high contrast */
        }
        .hover\:bg-custom-video-green-hover:hover {
            /* Slightly darker gray for hover effect: #BDBBB7 */
            background-color: #BDBBB7; 
            color: #1f2937;
        }

        /* Custom style for the Photo button (Dark Slate Blue #4863A0) */
        .bg-custom-photo-blue {
            background-color: #4863A0;
            color: white; /* Ensure text is white */
        }
        .hover\:bg-custom-photo-blue-hover:hover {
            /* Slightly darker blue for hover effect */
            background-color: #395085; 
        }
    </style>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons for Buttons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen bg-gray-50 p-4 sm:p-8">

<div class="max-w-xl mx-auto">
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Daily Log</h1>
        <p class="text-gray-500">Capture your day using text, voice, photos, or video.</p>
        <p id="user-status" class="text-xs mt-1 text-gray-400"></p>
    </header>

    <!-- Input Section -->
    <section class="bg-white p-6 rounded-lg shadow-md mb-8 border border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">New Entry</h2>
        
        <div id="error-message" class="hidden p-3 bg-red-50 text-red-600 border border-red-200 rounded-md mb-4 font-medium text-sm"></div>
        <div id="status-message" class="hidden p-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-md mb-4 font-medium text-sm"></div>
        
        <!-- Project Dropdown -->
        <div class="mb-3">
            <label for="project-select" class="block text-sm font-medium text-gray-700 mb-1">Assign to Project:</label>
            <select id="project-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="" disabled selected>Loading projects...</option>
            </select>
        </div>

        <textarea id="log-text" class="w-full p-3 h-24 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Type your thoughts here, or use the buttons below..."></textarea>
        
        <!-- Translation Output Area -->
        <div id="translation-output" class="hidden mt-4 p-3 bg-gray-100 border border-gray-300 rounded-md">
            <h3 class="text-sm font-semibold mb-1 text-gray-700 flex items-center">
                <i data-lucide="languages" class="w-4 h-4 mr-1"></i> Translation Result:
            </h3>
            <p id="translation-text" class="text-sm text-gray-800"></p>
        </div>
        
        <!-- Media Preview Area -->
        <div id="media-preview" class="mt-4 p-3 border border-gray-300 rounded-md hidden bg-gray-50">
            <h3 class="text-sm font-medium mb-2 text-gray-500">Media Attached:</h3>
            <!-- Content will be injected here -->
        </div>


        <div class="flex flex-wrap gap-2 mt-4">
            <!-- Voice Dictation Button (Red) -->
            <button id="voice-button" class="flex-1 min-w-[100px] flex items-center justify-center p-3 bg-red-600 text-white font-medium rounded-md hover:bg-red-700 transition disabled:opacity-50 text-sm" title="Start Voice Dictation">
                <i data-lucide="mic" class="w-4 h-4 mr-1"></i> 
                <span id="voice-label">Start Voice</span>
            </button>
            
            <!-- Photo Upload Button (DARK SLATE BLUE #4863A0) -->
            <button id="photo-button" class="flex-1 min-w-[100px] flex items-center justify-center p-3 bg-custom-photo-blue text-white font-medium rounded-md hover:bg-custom-photo-blue-hover transition disabled:opacity-50 text-sm" title="Upload Photo">
                <i data-lucide="camera" class="w-4 h-4 mr-1"></i> 
                Photo
            </button>
            <input type="file" id="photo-input" accept="image/*" class="hidden">

            <!-- Video Upload Button (LIGHT GRAY #D1D0CE) -->
            <button id="video-button" class="flex-1 min-w-[100px] flex items-center justify-center p-3 bg-custom-video-green text-gray-900 font-medium rounded-md hover:bg-custom-video-green-hover transition disabled:opacity-50 text-sm" title="Upload Video">
                <i data-lucide="video" class="w-4 h-4 mr-1"></i> 
                Video
            </button>
            <input type="file" id="video-input" accept="video/*" class="hidden">

            <!-- Save Button (HIGHLIGHT YELLOW #FFFF00) -->
            <button id="save-button" class="w-full flex-grow flex items-center justify-center p-3 bg-custom-yellow text-gray-900 font-semibold rounded-md hover:bg-custom-yellow-hover transition disabled:opacity-50 mt-2 text-base" disabled>
                <i data-lucide="save" class="w-5 h-5 mr-2"></i> 
                Save Log
            </button>
        </div>
    </section>

    <!-- Log History Section -->
    <section class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Log History</h2>
        <div id="log-history" class="space-y-4">
            <p id="loading-logs" class="text-center text-gray-500">Loading logs...</p>
        </div>
    </section>
</div>

<!-- Firebase SDK Imports (MUST be type="module") -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Provided by Canvas Environment) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
    const apiKey = ""; // API key is provided by the canvas environment for the fetch call
    
    // --- State and DOM Elements ---
    let db, auth, userId = null;
    let isAuthReady = false;
    let currentMedia = null; // Stores { type: 'image'/'video', data: base64_string }
    let projects = {}; // Store project lookup { id: name }
    
    // Voice recognition related variables
    let recognition = null;
    let isRecording = false;

    const logTextEl = document.getElementById('log-text');
    const projectSelectEl = document.getElementById('project-select');
    const saveButtonEl = document.getElementById('save-button');
    const voiceButtonEl = document.getElementById('voice-button');
    const photoButtonEl = document.getElementById('photo-button');
    const photoInputEl = document.getElementById('photo-input');
    const videoButtonEl = document.getElementById('video-button');
    const videoInputEl = document.getElementById('video-input');
    const logHistoryEl = document.getElementById('log-history');
    const mediaPreviewEl = document.getElementById('media-preview');
    const userStatusEl = document.getElementById('user-status');
    const voiceLabelEl = document.getElementById('voice-label');
    const errorEl = document.getElementById('error-message');
    const statusEl = document.getElementById('status-message');
    const translationOutputEl = document.getElementById('translation-output');
    const translationTextEl = document.getElementById('translation-text');
    
    // --- Utility Functions ---

    const showMessage = (element, message, isError = false) => {
        element.textContent = message;
        element.classList.remove('hidden');
        // Reset classes to ensure only one style is applied
        element.className = element.className.split(' ').filter(c => !c.startsWith('bg-') && !c.startsWith('text-') && !c.startsWith('border-')).join(' ');
        element.classList.add('p-3', 'rounded-md', 'mb-4', 'font-medium', 'text-sm');

        if (isError) {
            element.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-200');
        } else {
            element.classList.add('bg-blue-50', 'text-blue-600', 'border', 'border-blue-200');
        }
        setTimeout(() => element.classList.add('hidden'), 5000);
    };

    const setError = (message) => showMessage(errorEl, message, true);
    const setStatus = (message) => showMessage(statusEl, message, false);

    const checkSaveEnablement = () => {
        const hasText = logTextEl.value.trim().length > 0;
        const hasMedia = currentMedia !== null;
        const hasProject = projectSelectEl.value.length > 0;
        saveButtonEl.disabled = !(hasText || hasMedia) || !hasProject;
        
        // Hide translation output if text is cleared
        if (!hasText) {
             translationOutputEl.classList.add('hidden');
             translationTextEl.textContent = '';
        }
    };

    const getFirestorePath = (collectionName, docId) => {
        const base = `/artifacts/${appId}/users/${userId}/${collectionName}`;
        // When docId is null/undefined, this returns a CollectionReference, otherwise a DocumentReference
        return docId ? doc(db, base, docId) : collection(db, base);
    };
    
    // --- Firebase Setup ---
    const initializeFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else if (!user && initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (e) {
                        console.error("Custom token sign-in failed, falling back to anonymous:", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'anonymous';
                isAuthReady = true;
                userStatusEl.textContent = `User ID: ${userId}`;
                
                // Set up listeners for projects and logs once authenticated
                setupProjectListener();
                setupLogListener();
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setError("Failed to initialize the database.");
        }
    };
    
    // --- Project Management ---

    const createDefaultProject = async () => {
        // Use a fixed ID for the default project so it's always available for testing
        const defaultDocRef = doc(getFirestorePath('projects'), 'default-project'); 
        try {
            await setDoc(defaultDocRef, { 
                name: 'General Test Log', 
                timestamp: serverTimestamp() 
            }, { merge: true });
        } catch (e) {
            console.error("Error creating default project:", e);
        }
    };

    const setupProjectListener = () => {
        if (!db || !userId) return;

        const q = query(getFirestorePath('projects'));
        
        onSnapshot(q, (snapshot) => {
            projects = {};
            projectSelectEl.innerHTML = '';
            
            if (snapshot.empty) {
                // If no projects exist, create a default one (TEST PROJECT)
                createDefaultProject();
                // Ensure the select box doesn't stay stuck on 'Loading projects...'
                projectSelectEl.innerHTML = '<option value="" disabled selected>No projects available</option>';
                return;
            }

            // Create options and populate projects map
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                projects[id] = data.name;

                const option = document.createElement('option');
                option.value = id;
                option.textContent = data.name;
                projectSelectEl.appendChild(option);
            });
            
            // Set the first project as selected (which should be the default one for testing)
            if (projectSelectEl.options.length > 0) {
                projectSelectEl.selectedIndex = 0;
            }
            checkSaveEnablement();

        }, (error) => {
            console.error("Error fetching projects:", error);
            setError("Failed to load projects.");
        });
    };
    
    // --- Real-time Log Listener ---
    const setupLogListener = () => {
        if (!db || !userId) return;

        const q = query(getFirestorePath('daily_logs'));
        
        onSnapshot(q, (snapshot) => {
            logHistoryEl.innerHTML = '';
            
            if (snapshot.empty) {
                logHistoryEl.innerHTML = '<p class="text-center text-gray-500 p-4">No logs yet. Start documenting your day!</p>';
                document.getElementById('loading-logs')?.remove();
                return;
            }

            // Map and sort entries by timestamp (latest first)
            snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0))
                .forEach(entry => {
                    logHistoryEl.appendChild(createLogElement(entry));
                });
            
            lucide.createIcons();
        }, (error) => {
            console.error("Error fetching logs:", error);
            setError("Failed to load log history in real-time.");
        });
    };

    // --- DOM Creation for Log Entry ---
    const createLogElement = (entry) => {
        const date = entry.timestamp ? entry.timestamp.toDate().toLocaleString() : 'Saving...';
        const projectName = projects[entry.projectId] || 'Unassigned Project';
        
        const div = document.createElement('div');
        div.className = 'p-4 bg-white rounded-lg shadow-sm border border-gray-100';
        
        let mediaHtml = '';
        if (entry.media) {
            const mediaType = entry.media.type;
            const mediaData = entry.media.data;
            
            if (mediaType === 'image') {
                mediaHtml = `<img src="data:image/jpeg;base64,${mediaData}" alt="Logged Image" class="w-full h-auto max-h-60 object-contain rounded-md mt-3 border border-gray-300">`;
            } else if (mediaType === 'video') {
                mediaHtml = `<video controls src="data:video/mp4;base64,${mediaData}" class="w-full h-auto max-h-60 object-contain rounded-md mt-3 border border-gray-300">Video Log</video>`;
            }
        }
        
        // Display translation in italics as requested
        let translationDisplay = '';
        if (entry.translation && entry.translation.translatedText) {
            const originalLang = entry.translation.detectedLanguage || 'Original';
            const targetLang = entry.translation.targetLanguage || 'Translated';

            translationDisplay = `
                <p class="text-gray-500 text-sm italic mt-2 pt-2 border-t border-gray-100">
                    [${originalLang} to ${targetLang}] ${entry.translation.translatedText}
                </p>
            `;
        }


        div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div>
                    <span class="text-xs font-medium text-blue-600 flex items-center">
                        <i data-lucide="calendar" class="w-3 h-3 mr-1"></i> ${date}
                    </span>
                    <span class="text-xs font-semibold text-gray-500 flex items-center mt-1">
                        <i data-lucide="folder-open" class="w-3 h-3 mr-1"></i> ${projectName}
                    </span>
                </div>
                <button class="delete-log text-red-500 hover:text-red-700 transition-colors" data-id="${entry.id}" title="Delete Log">
                     <i data-lucide="trash-2" class="w-4 h-4"></i> 
                </button>
            </div>
            <p class="text-gray-700 text-sm whitespace-pre-wrap">${entry.text || 'No text recorded.'}</p>
            ${translationDisplay}
            ${mediaHtml}
        `;
        
        const deleteButton = div.querySelector('.delete-log');
        if(deleteButton) {
            deleteButton.addEventListener('click', () => handleDeleteLog(entry.id));
        }

        return div;
    };
    
    // --- Log Saving Function ---
    const handleSaveLog = async () => {
        if (!db || !userId || saveButtonEl.disabled) return;

        const text = logTextEl.value.trim();
        const projectId = projectSelectEl.value;

        if (!text && !currentMedia) {
            setError("Log must contain text or media.");
            return;
        }

        if (!projectId) {
            setError("Please select a project before saving.");
            return;
        }

        setStatus("Saving log entry...");
        saveButtonEl.disabled = true;

        // Extract translation data if available in the UI
        let translationData = null;
        if (!translationOutputEl.classList.contains('hidden')) {
            const fullText = translationTextEl.textContent;
            // The format is: (Lang1 to Lang2): Translation Text
            const match = fullText.match(/\((.+?) to (.+?)\):\s*(.*)/s); 

            if (match) {
                 translationData = {
                     detectedLanguage: match[1].trim(),
                     targetLanguage: match[2].trim(),
                     translatedText: match[3].trim()
                 };
            }
        }
        
        try {
            const logData = {
                text: text,
                projectId: projectId,
                media: currentMedia, // currentMedia is null if no media attached
                translation: translationData,
                timestamp: serverTimestamp(),
            };

            // This is the correct way to save a document with an auto-generated ID.
            await setDoc(doc(getFirestorePath('daily_logs')), logData);

            // Clear state on success
            logTextEl.value = '';
            currentMedia = null;
            clearMediaPreview();
            translationOutputEl.classList.add('hidden');
            translationTextEl.textContent = '';
            setStatus("Log saved successfully! Check Log History below.");
        } catch (e) {
            console.error("Error saving log:", e);
            setError("Failed to save log entry. See console for details.");
        } finally {
            saveButtonEl.disabled = false;
            checkSaveEnablement();
        }
    };
    
    // --- Log Deletion Function ---
    const handleDeleteLog = async (docId) => {
        if (!db || !userId) return;
        
        setStatus("Deleting log...");
        
        try {
            await deleteDoc(getFirestorePath('daily_logs', docId));
            setStatus("Log deleted.");
        } catch (e) {
            console.error("Error deleting log:", e);
            setError("Failed to delete log entry.");
        }
    };

    // --- Media Input Handlers ---
    
    const clearMediaPreview = () => {
        currentMedia = null;
        mediaPreviewEl.classList.add('hidden');
        mediaPreviewEl.innerHTML = '<h3 class="text-sm font-medium mb-2 text-gray-500">Media Attached:</h3>';
        checkSaveEnablement();
    };

    const handleMediaChange = (event, type) => {
        const file = event.target.files[0];
        if (!file) {
            clearMediaPreview();
            return;
        }

        const reader = new FileReader();
        reader.onloadend = () => {
            const base64Data = reader.result.split(',')[1];
            currentMedia = { type: type, data: base64Data };

            // Update Preview
            mediaPreviewEl.classList.remove('hidden');
            if (type === 'image') {
                mediaPreviewEl.innerHTML = `<h3 class="text-sm font-medium mb-2 text-gray-500">Photo Attached:</h3><img src="${reader.result}" class="w-full h-auto max-h-40 object-contain rounded-md">`;
            } else if (type === 'video') {
                mediaPreviewEl.innerHTML = `<h3 class="text-sm font-medium mb-2 text-gray-500">Video Attached:</h3><video controls src="${reader.result}" class="w-full h-auto max-h-40 object-contain rounded-md">`;
            }

            checkSaveEnablement();
            setStatus(`${type.charAt(0).toUpperCase() + type.slice(1)} attached successfully. Ready to save!`);
        };
        
        reader.readAsDataURL(file);
    };

    // --- LLM Translation Handler (Bidirectional) ---

    const translateAndDetect = async (text) => {
        if (!text.trim()) {
            return null;
        }

        // Use the voice button as a temporary loading indicator since the translate button is gone
        voiceButtonEl.disabled = true;
        voiceLabelEl.textContent = 'Translating...';
        
        translationOutputEl.classList.remove('hidden');
        translationTextEl.textContent = 'Processing translation...';
        
        // Ensure voice button icon is set to loader
        const voiceIcon = voiceButtonEl.querySelector('i');
        if (voiceIcon) {
             voiceIcon.setAttribute('data-lucide', 'loader-2');
             voiceIcon.classList.add('animate-spin');
        }

        try {
            const systemPrompt = "Analyze the user's input text to detect its language. Then, if the detected language is English, translate it into Spanish. If the detected language is NOT English, translate it into English. Respond only with a JSON object containing the original text, detected language (using its full name), the target language (full name), and the translated text.";
            const userQuery = `Analyze and translate this text: "${text}"`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "originalText": { "type": "STRING" },
                            "detectedLanguage": { "type": "STRING" },
                            "targetLanguage": { "type": "STRING" },
                            "translatedText": { "type": "STRING" }
                        },
                        "propertyOrdering": ["originalText", "detectedLanguage", "targetLanguage", "translatedText"]
                    }
                }
            };
            
            let result;
            let attempts = 0;
            const maxAttempts = 3;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    result = await response.json();
                    break; 

                } catch (e) {
                    attempts++;
                    if (attempts >= maxAttempts) throw e;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
            
            const candidate = result?.candidates?.[0];
            const jsonText = candidate?.content?.parts?.[0]?.text;

            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                
                const translationResult = `(${parsedJson.detectedLanguage} to ${parsedJson.targetLanguage}): ${parsedJson.translatedText}`;
                translationTextEl.textContent = translationResult;
                setStatus(`Translation complete: ${parsedJson.detectedLanguage} detected.`);
            } else {
                translationTextEl.textContent = 'Translation service returned no content.';
                setError('Failed to get translation content from the API.');
            }

        } catch (e) {
            console.error("Translation API Error:", e);
            translationTextEl.textContent = 'Could not translate: Service failed or returned invalid data.';
            setError('Translation failed. Check the console for API errors.');
        } finally {
            voiceButtonEl.disabled = false;
            voiceLabelEl.textContent = 'Start Voice';
            // Restore voice button icon
            const voiceIcon = voiceButtonEl.querySelector('i');
            if (voiceIcon) {
                voiceIcon.setAttribute('data-lucide', 'mic');
                voiceIcon.classList.remove('animate-spin');
            }
        }
    };


    // --- Voice Recognition Logic (Web Speech API) ---
    const initializeSpeechRecognition = () => {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            setError("Your browser does not support Web Speech API for voice dictation.");
            voiceButtonEl.disabled = true;
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.interimResults = true;
        recognition.continuous = true;
        recognition.lang = 'en-US'; // Default language

        recognition.onstart = () => {
            isRecording = true;
            voiceLabelEl.textContent = 'Recording... Say "STOP" to save.';
            voiceButtonEl.classList.add('voice-recording');
            setStatus("Listening for your voice input...");
        };

        recognition.onresult = (event) => {
            let interim_transcript = '';
            let final_transcript = '';
            
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    final_transcript += transcript;
                } else {
                    interim_transcript += transcript;
                }
            }
            
            let currentText = logTextEl.value.replace(/ \(.*?\)/g, '').trim();

            if (final_transcript.toLowerCase().includes('stop')) {
                // Stop command detected
                logTextEl.value = currentText + final_transcript.replace(/stop/i, '').trim();
                recognition.stop();
                return;
            }

            // Append new speech to the text area
            const speechIndicator = interim_transcript ? ` (${interim_transcript})` : '';
            logTextEl.value = currentText + final_transcript + speechIndicator;
            checkSaveEnablement();
        };

        recognition.onerror = (event) => {
            console.error('Speech Recognition Error:', event.error);
            setError(`Speech Recognition Error: ${event.error}`);
            isRecording = false;
            voiceLabelEl.textContent = 'Start Voice';
            voiceButtonEl.classList.remove('voice-recording');
        };

        recognition.onend = async () => {
            if (isRecording) {
                // This means the user did not say "stop" and the browser stopped listening.
                setStatus("Voice dictation paused by the browser (max duration reached). Click to resume or save.");
                isRecording = false;
                voiceLabelEl.textContent = 'Start Voice';
                voiceButtonEl.classList.remove('voice-recording');
            }
            // If the text area has content, trigger the translation service
            const textToTranslate = logTextEl.value.replace(/ \(.*?\)/g, '').trim();
            if (textToTranslate) {
                await translateAndDetect(textToTranslate);
            }
            checkSaveEnablement();
        };
    };

    const toggleSpeechRecognition = () => {
        if (!recognition) return;

        if (isRecording) {
            recognition.stop();
            isRecording = false;
        } else {
            try {
                // Clear any potential interim text before starting
                logTextEl.value = logTextEl.value.replace(/ \(.*?\)/g, '').trim();
                recognition.start();
            } catch (e) {
                console.error("Recognition start failed:", e);
                setError("Could not start voice recognition. Please try again.");
            }
        }
    };

    // --- Event Listeners ---
    
    // Auth and Initialization
    window.onload = initializeFirebase;
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons(); // Initialize Lucide icons
        initializeSpeechRecognition();

        logTextEl.addEventListener('input', checkSaveEnablement);
        projectSelectEl.addEventListener('change', checkSaveEnablement);
        saveButtonEl.addEventListener('click', handleSaveLog);
        
        // Voice Button
        voiceButtonEl.addEventListener('click', toggleSpeechRecognition);

        // Photo Input
        photoButtonEl.addEventListener('click', () => photoInputEl.click());
        photoInputEl.addEventListener('change', (e) => handleMediaChange(e, 'image'));

        // Video Input
        videoButtonEl.addEventListener('click', () => videoInputEl.click());
        videoInputEl.addEventListener('change', (e) => handleMediaChange(e, 'video'));
    });

</script>
</body>
</html>
